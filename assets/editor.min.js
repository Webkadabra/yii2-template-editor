function Editor(){function a(b){k||(d.history.change(d.selected.items(),["x","y"]),k=!0);var a=b.x-f.x,c=b.y-f.y;keyModeShift&&(10<Math.abs(a)||10<Math.abs(c))&&(Math.abs(a)>Math.abs(c)?c=0:a=0);d.selected.each(function(){this.x=this.old.x+a;this.y=this.old.y+c});d.markers.update();d.update()}function c(b){k||(d.history.change(d.selected.items(),["x","y","width","height"]),k=!0);var a=b.x-h.x,c=b.y-h.y;keyModeShift&&(10<Math.abs(a)||10<Math.abs(c))&&(Math.abs(a)>Math.abs(c)?c=Math.abs(a)*(c/a):a=
Math.abs(c)*(a/c));d.selected.each(function(){if(2==e||4==e||7==e)this.width=this.old.width+a*this.old.rw,10>this.width&&(this.width=10),this.x=this.old.x+a*(1-this.old.rx);else if(0==e||3==e||5==e)this.width=this.old.width-a*this.old.rx,10>this.width?this.width=10:this.x=this.old.x+a*this.old.rx;if(5==e||6==e||7==e)this.height=this.old.height+c*this.old.rh,10>this.height&&(this.height=10),this.y=this.old.y+c*(1-this.old.ry);else if(0==e||1==e||2==e)this.height=this.old.height-c*this.old.rh,10>this.height?
this.height=10:this.y=this.old.y+c*this.old.ry;this.updateTextLines(d.context)});d.markers.update();d.update()}function b(){d.selected.each(function(){this.updateOld()})}function g(){d.context.clearRect(0,0,d.canvas.width,d.canvas.height);d.objects.each(function(){this.draw(d.context)})}this.objects=new EditorGroup;this.selected=new EditorGroup;this.selectedObject=null;this.markers=new Markers(this);this.history=new EditorHistory(this);this.fn=new EditorFunctions(this);this.canvas=document.getElementById("paper");
this.context=this.canvas.getContext("2d");this.showFrame=!0;this.printMode=!1;var f=this.onObjectChange=null,e=null,h=null,k=!1,d=this;this.selectObject=function(b){d.selected.add(b);d.markers.update();1==d.selected.count()?d.selectedObject=d.selected.item(0):d.selectedObject=null};this.unselectAll=function(){this.selected.count()&&(this.selected.clear(),this.markers.update(),d.selectedObject=null)};this.print=function(){this.printMode=!0;g();this.printMode=!1};this.draw=function(){g();d.markers.draw()};
this.update=function(){this.draw();this.onObjectChange.call(this)};this.canvas.onmousemove=function(b){var e=d.fn.windowToCanvas(b.clientX,b.clientY);if(f)a(e);else if(h)c(e);else{b=d.canvas.style.cursor;var g="default",k=d.markers.testPoint(e);null===k?d.objects.each(function(){if(this.testPoint(e))return g="move",!1}):g=d.markers.cursors[k];g!=b&&(d.canvas.style.cursor=g)}};this.canvas.onmouseup=function(b){if(h)h=null;else{var a=d.fn.windowToCanvas(b.clientX,b.clientY);if(f){b=a.x-f.x;var c=a.y-
f.y;f=null;if(5<Math.abs(b)||5<Math.abs(c))return}var e=!1;d.objects.reverseEach(function(){if(this.testPoint(a)){e=!0;if(keyModeCtrl){if(d.selected.remove(this))return d.markers.update(),!1}else d.unselectAll();d.selectObject(this);return!1}});e||keyModeCtrl||d.unselectAll();d.onObjectChange.call(this);d.draw()}};this.canvas.onmousedown=function(a){if(null===f){var c=d.fn.windowToCanvas(a.clientX,a.clientY);a=d.markers.testPoint(c);null!==a?(b(),e=a,h=c,k=!1):d.selected.each(function(){if(this.testPoint(c))return b(),
f=c,k=!1})}}};var EditorFunctions=function(a){var c=function(b){"string"===typeof b&&(b=parseFloat(b.replace(",",".")));return b};this.toUnit=function(b){return c(b)/37.795};this.fromUnit=function(b){return 37.795*parseFloat(c(b))};this.windowToCanvas=function(b,c){var f=a.canvas.getBoundingClientRect();return{x:b-a.canvas.width/f.width*f.left,y:c-a.canvas.height/f.height*f.top}};this.clone=function(){if(a.selected.count()){var b=[];a.selected.each(function(){var a=this.clone();a.x+=20;a.y+=20;a.update();b.push(a)});
a.history.create(b);a.unselectAll();for(var c=0,f=b.length;c<f;c++)a.selectObject(b[c]);a.update()}};this.remove=function(){a.selected.count()&&(a.history.remove(a.selected.items()),a.selected.each(function(){a.objects.remove(this)}),a.unselectAll(),a.update())};this.align=function(){if(a.selected.count()){var b=a.selected.item(0),c=$(this).data("prop");a.history.change(a.selected.items(),["x","y"]);a.selected.each(function(){switch(c){case "left":this.x=b.x;break;case "center":this.x=b.x+b.width/
2-this.width/2;break;case "right":this.x=b.x+b.width-this.width;break;case "top":this.y=b.y;break;case "middle":this.y=b.y+b.height/2-this.height/2;break;case "bottom":this.y=b.y+b.height-this.height}});a.markers.update();a.update()}}};function EditorGroup(){var a=[];this.add=function(c){a.push(c)};this.remove=function(c){for(var b=0,g=a.length;b<g;b++)if(c==a[b])return a.splice(b,1),b;return null};this.item=function(c){return a[c]};this.items=function(){return a};this.clear=function(){a=[]};this.count=function(){return a.length};this.each=function(c){for(var b=0,g=a.length;b<g&&!1!==c.call(a[b]);b++);};this.reverseEach=function(c){for(var b=a.length-1;0<=b&&!1!==c.call(a[b]);b--);}};function EditorHistory(a){var c=[],b=0,g=this;this.enableRedo=this.enableUndo=!1;this.onChange=null;var f=function(a,e,f){c[b]={operation:a,objects:e};if(f){a=[];for(var k=f.length,h=0,p=e.length;h<p;h++)for(var l=0;l<k;l++)e[h].hasOwnProperty(f[l])&&(a[f[l]]=e[h][f[l]]);c[b].props=a}100==c.length?(100).splice(0,1):b++;g.enableUndo=!0;g.onChange&&g.onChange.call(g)};this.change=function(a,b){f(0,a,b)};this.create=function(a){f(1,a)};this.remove=function(a){f(2,a)};var e=function(){var d,e,f=c[b].objects,
g=f.length,k=c[b].props;for(d=0;d<g;d++){for(var h in k)e=f[d][h],f[d][h]=k[h],k[h]=e;f[d].update();a.selectObject(f[d])}},h=function(){var d,e=c[b].objects,f=e.length;for(d=0;d<f;d++)a.objects.add(e[d]),a.selectObject(e[d])},k=function(){var d,e=c[b].objects,f=e.length;for(d=0;d<f;d++)a.objects.remove(e[d])};this.undo=function(){if(0<b){b--;a.unselectAll();switch(c[b].operation){case 0:e();break;case 1:k();break;case 2:h()}a.markers.update();a.update();g.enableUndo=0<b;g.enableRedo=!0;g.onChange&&
g.onChange.call(g)}};this.redo=function(){if(b<c.length){a.unselectAll();switch(c[b].operation){case 0:e();break;case 1:h();break;case 2:k()}a.markers.update();a.update();b++;g.enableUndo=!0;g.enableRedo=b<c.length;g.onChange&&g.onChange.call(g)}}};var editor,keyModeCtrl,keyModeShift,isChange=!1;function showNoty(a){return noty({text:a.text,theme:"defaultTheme",layout:a.layout?a.layout:"bottomLeft",type:a.type?a.type:"information",dismissQueue:!1,timeout:a.timeout?a.timeout:1400,modal:a.modal?a.modal:!1,closeWith:a.modal?[]:["click"],force:!0,killer:!0})}showNoty({text:"\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430...",theme:"defaultTheme",layout:"topCenter",type:"success",timeout:!1});
jQuery.fn.disableSelection=function(){this.each(function(){this.onselectstart=function(){return!1};this.unselectable="on";jQuery(this).css({"-moz-user-select":"none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"});jQuery(this).bind("mousedown",function(){return!1})})};jQuery.fn.disabled=function(a){$(this).each(function(){a?$(this).attr("disabled","disabled"):$(this).removeAttr("disabled")});return $(this)};
function changeObjectColor(){if(editor.selectedObject){var a=$(this),c=a.data("te-prop");"undefined"===typeof c&&(c=a.parent().next("input").data("te-prop"));editor.selectedObject[c]=a.val();editor.update()}}
$(function(){function a(a){if(editor.selectedObject){var b;$(this).hasClass("active")?(b=!1,$(this).removeClass("active")):(b=!0,$(this).addClass("active"));editor.history.change([editor.selectedObject],[a.data.param]);editor.selectedObject[a.data.param]=b;editor.selectedObject.updateFont();editor.update()}}function c(a){var b=editor.canvas.width,c=editor.canvas.height;editor.canvas.width=2*b;editor.canvas.height=2*c;editor.context.scale(2,2);editor.print();a=a?window.open():window;a.document.write('<head><title>NovatorPrint</title><style>@page :first {margin: 0;} @page :left { margin: 0; } @page :right { margin: 0; } @media print and (color) { * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }} body {margin:0}</style></head><body><img width="'+
b+'" height="'+c+'" src="'+editor.canvas.toDataURL()+'"></body>');a.print();a.close();editor.context.scale(1,1);editor.canvas.width=b;editor.canvas.height=c;editor.update();keyModeShift=keyModeCtrl=null}var b=$("#te-btn-save"),g=$("#te-btn-print"),f=$("#save-config"),e=$("#te-btn-copy"),h=$("#te-btn-create"),k=$("#te-btn-undo"),d=$("#te-btn-redo"),m=$("#te-btn-delete"),n=$("#te-text"),y=$("#te-templates"),z=$("#te-font"),p=$("#te-btn-bold"),l=$("#te-btn-italic"),t=$(".align"),A=$(".m-align"),w=$("[data-te-size-prop]"),
x=$("[data-te-prop]"),q=$(".valign");editor=new Editor;editor.onObjectChange=function(a){editor.selectedObject?($(".only-select").disabled(!1),w.each(function(){var a=editor.selectedObject[$(this).data("te-size-prop")];$(this).val(editor.fn.toUnit(a).toFixed(2))}),a||(x.each(function(){$(this).val(editor.selectedObject[$(this).data("te-prop")])}),n.val(editor.selectedObject.getText()),t.removeClass("active"),$('.align[data-te-prop="'+editor.selectedObject.textAlign+'"]').addClass("active"),q.each(function(){$(this).parent().removeClass("active")}),
$('.valign[data-te-prop="'+editor.selectedObject.textBaseline+'"]').parent().addClass("active"),editor.selectedObject.fontBold?p.addClass("active"):p.removeClass("active"),editor.selectedObject.fontItalic?l.addClass("active"):l.removeClass("active"))):($(".only-select, .only-select2").disabled(!0),1<editor.selected.count()&&$(".only-select2").disabled(!1))};editor.history.onChange=function(){isChange=!0;b.disabled(!1);k.disabled(!this.enableUndo);d.disabled(!this.enableRedo)};h.click(function(){var a=
new EditorObject(editor);a.text="\u0422\u0435\u043a\u0441\u0442";a.width=a.height=150;a.x=editor.canvas.width/2-a.width/2;a.y=editor.canvas.height/2-a.height/2;a.update();editor.history.create([a]);editor.unselectAll();editor.selectObject(a);editor.update()});g.click(function(){c(!0)});$("#te-btn-close").click(function(){if(!isChange||confirm("\u0412\u044b \u0441\u043e\u0431\u0438\u0440\u0430\u0435\u0442\u0435\u0441\u044c \u0443\u0439\u0442\u0438 \u0441\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b. \u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u0431\u0443\u0434\u0443\u0442 \u043f\u043e\u0442\u0435\u0440\u044f\u043d\u044b. \u0423\u0439\u0442\u0438?"))location.href=
$(this).data("url")});f.click(function(){var a=$("#form-config");$("#modal-config").modal("hide");$.post(a.attr("action"),a.serialize(),function(a){a.result?(editor.canvas.width=editor.fn.fromUnit($("#template-width").val()),editor.canvas.height=editor.fn.fromUnit($("#template-height").val()),editor.update()):$("#modal-config").modal("show");showNoty({text:a.message,type:a.result?"success":"error"})})});b.click(function(){var a=new Serialize,a={id:templateData.id,objects:a.save(editor.objects)},c=
showNoty({text:"\u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435...",theme:"defaultTheme",timeout:!1});$.post(templateData.saveUrl,a,function(a){c.setText(a.message);c.setType(a.result?"success":"error");b.disabled(!0);isChange=!1})});k.click(editor.history.undo);d.click(editor.history.redo);m.click(editor.fn.remove);e.click(editor.fn.clone);x.change(function(){if(editor.selectedObject){var a=$(this).attr("data-te-prop"),b=$(this).val();$(this).attr("data-unit")&&(b=editor.fn.fromUnit(b));
editor.history.change([editor.selectedObject],[a]);editor.selectedObject[a]=b;editor.selectedObject.update();editor.markers.update(editor.selected);editor.draw()}});w.change(function(){if(editor.selectedObject){var a=$(this).attr("data-te-size-prop");editor.history.change([editor.selectedObject],[a]);editor.selectedObject[a]=editor.fn.fromUnit($(this).val());editor.selectedObject.update();editor.markers.update(editor.selected);editor.draw()}});var u=!1,v=!1;n.bind("keyup change",function(){editor.selectedObject&&
(u&&!v&&(editor.history.change([editor.selectedObject],["text"]),v=!0),editor.selectedObject.setText($(this).val()),editor.draw())}).focus(function(){u=!0;v=!1}).blur(function(){u=!1});y.dblclick(function(){editor.selectedObject&&(n.val(n.val()+$(this).val()),n.change())});q.click(function(){editor.selectedObject&&(editor.selectedObject.textBaseline=$(this).data("te-prop"),editor.selectedObject.updateTextLines(),editor.update(),q.each(function(){$(this).parent().removeClass("active")}),$(this).parent().addClass("active"))});
z.change(function(){editor.selectedObject&&(editor.history.change([editor.selectedObject],["fontFamily"]),editor.selectedObject.fontFamily=$(this).val(),editor.selectedObject.updateTextLines(),editor.update())});p.click({param:"fontBold"},a);l.click({param:"fontItalic"},a);t.click(function(){editor.selectedObject&&(editor.history.change([editor.selectedObject],["textAlign"]),editor.selectedObject.textAlign=$(this).data("te-prop"),editor.update(),t.removeClass("active"),$(this).addClass("active"));
return!1});q.click(function(){editor.selectedObject&&(editor.history.change([editor.selectedObject],["textBaseline"]),editor.selectedObject.textBaseline=$(this).data("te-prop"),editor.update(),q.each(function(){$(this).parent().removeClass("active")}),$(this).parent().addClass("active"));return!1});A.click(editor.fn.align);var r=$(".middle");r.length&&(f=function(){var a=$(window).height()-r.offset().top;r.height(a)},$(window).resize(f),f());r.disableSelection();r.click(editor.unselectAll);$(".only-select").disabled(!0);
b.disabled(!0);$(document).keydown(function(a){keyModeCtrl=a.ctrlKey;keyModeShift=a.shiftKey;if(a.ctrlKey)switch(String.fromCharCode(a.which).toLowerCase()){case "s":a.preventDefault();b.click();break;case "p":a.preventDefault();g.click();break;case "d":a.preventDefault();e.click();break;case "z":a.shiftKey?d.click():k.click();a.preventDefault();break;case "b":p.click();break;case "i":l.click()}}).keyup(function(a){keyModeCtrl=a.ctrlKey;keyModeShift=a.shiftKey;switch(a.which){case 46:(!this.activeElement||
"TEXTAREA"!=this.activeElement.nodeName&&"INPUT"!=this.activeElement.nodeName)&&m.click()}});$.get(templateData.loadUrl,function(a){(new Serialize).load(editor,a,function(a){a&&($.noty.closeAll(),"1"==$("#fast-print").val()?c():editor.update())})})});function Markers(a){this.height=this.width=this.y=this.x=0;var c=!1,b=[],g=this;this.cursors="nw-resize n-resize sw-resize w-resize w-resize sw-resize n-resize nw-resize".split(" ");this.update=function(){if(0==a.selected.count())c=!1;else{c=!0;var f=0,e=0;g.x=Infinity;g.y=Infinity;a.selected.each(function(){g.x>this.x&&(g.x=this.x);g.y>this.y&&(g.y=this.y);f<this.x+this.width&&(f=this.x+this.width);e<this.y+this.height&&(e=this.y+this.height)});this.width=f-this.x;this.height=e-this.y;b[0]={x:this.x-
6,y:this.y-6};b[1]={x:this.x+this.width/2-3,y:this.y-6};b[2]={x:this.x+this.width,y:this.y-6};b[3]={x:this.x-6,y:this.y+this.height/2-3};b[4]={x:this.x+this.width,y:this.y+this.height/2-3};b[5]={x:this.x-6,y:this.y+this.height};b[6]={x:this.x+this.width/2-3,y:this.y+this.height};b[7]={x:this.x+this.width,y:this.y+this.height}}};this.testPoint=function(a){if(c)for(var e=0;8>e;e++)if(a.x>b[e].x&&a.y>b[e].y&&a.x<b[e].x+6&&a.y<b[e].y+6)return e;return null};this.draw=function(){if(c){a.context.fillStyle=
"#337AB7";for(var f=0;8>f;f++)a.context.fillRect(b[f].x,b[f].y,6,6)}}};function EditorObject(a){this.lineWidth=this.height=this.width=this.y=this.x=0;this.strokeStyle="#000000";this.fillStyle=null;this.textStyle="#000000";this.textAlign="center";this.textBaseline="middle";this.lineHeight=25;this.fontFamily="Arial";this.fontSize=16;this.fontItalic=this.fontBold=!1;this.image=this.text=null;this.old={};this.font="";this.lines=[];this.textHeight=0;a.objects.add(this);this.clone=function(){var c=new EditorObject(a),b;for(b in this)c.hasOwnProperty(b)&&(c[b]=this[b]);return c};
this.testPoint=function(a){return a.x>this.x&&a.y>this.y&&a.x<this.x+this.width&&a.y<this.y+this.height};this.updateOld=function(){this.old.x=this.x;this.old.y=this.y;this.old.width=this.width;this.old.height=this.height;this.old.rx=a.markers.x/this.x;this.old.rw=this.width/a.markers.width;this.old.ry=a.markers.y/this.y;this.old.rh=this.height/a.markers.height};this.setText=function(a){this.text=a;this.updateTextLines()};this.getText=function(){return this.text};this.update=function(){this.updateFont();
this.updateTextLines()};this.updateFont=function(){this.font="";this.fontItalic&&(this.font+="italic ");this.fontBold&&(this.font+="bold ");this.lineHeight=1.4*this.fontSize;this.font+=this.fontSize+"pt "+this.fontFamily};this.updateTextLines=function(){this.lines=[];if(this.text&&""!=this.text){var c=this.text.split("\n"),b=c.length,g=a.context;this.textHeight=this.lineHeight*b;a.context.font=this.font;for(var f=0;f<b;f++){for(var e="",h=c[f].split(" "),k=0,d=h.length;k<d;k++){var m=e+h[k];g.measureText(m).width>
this.width-10?(this.lines.push(e),this.textHeight+=this.lineHeight,e=h[k]+" "):e=m+" "}this.lines.push(e)}this.textHeight-=this.lineHeight}};this.draw=function(){var c=a.context;this.fillStyle&&(c.fillStyle=this.fillStyle,c.fillRect(this.x,this.y,this.width,this.height));this.image&&c.drawImage(this.image,20,20,this.image.naturalWidth-40,this.image.naturalHeight-40,this.x,this.y,this.width,this.image.naturalHeight*this.width/this.image.naturalWidth);0<this.lineWidth?(c.strokeStyle=this.strokeStyle,
c.lineWidth=this.lineWidth,c.setLineDash([]),c.strokeRect(this.x,this.y,this.width,this.height)):this.fillStyle||!a.showFrame||a.printMode||(c.setLineDash([1,2]),c.strokeStyle="#888888",c.lineWidth=1,c.strokeRect(this.x,this.y,this.width,this.height));var b;if(b=this.lines.length){c.fillStyle=this.textStyle;c.font=this.font;c.textAlign=this.textAlign;c.textBaseline=this.textBaseline;var g,f;f="left"==this.textAlign?this.x:"right"==this.textAlign?this.x+this.width:this.x+this.width/2;g="top"==this.textBaseline?
this.y:"bottom"==this.textBaseline?this.y+this.height-this.textHeight:this.y+this.height/2-this.textHeight/2;for(var e=0;e<b;e++)c.fillText(this.lines[e],f,g),g+=this.lineHeight}}};function Serialize(){var a="x y width height text lineWidth strokeStyle fillStyle textStyle textAlign textBaseline lineHeight fontFamily fontSize fontBold fontItalic".split(" ");this.save=function(c){var b=[],g,f=a.length;c.each(function(){var c={};for(g=0;g<f;g++)c[a[g]]=this[a[g]];b.push(c)});return JSON.stringify({version:"1.0.0",objects:b})};this.load=function(c,b,g){if(""==b)return!1;if((b=JSON.parse(b))&&b.hasOwnProperty("version")&&b.hasOwnProperty("objects")&&"1.0.0"==b.version){b=b.objects;
var f=a.length,e,h,k,d=0;e=0;for(k=b.length;e<k;e++){var m=new EditorObject(c);for(h=0;h<f;h++)m[a[h]]=b[e][a[h]]}var n=function(a){d--;0==d&&g(!0)};c.objects.each(function(){var a=/\[image:(.*)\]/.exec(this.text);a?(d++,this.image=new Image,-1!=a[1].indexOf("http")&&(this.image.crossOrigin=""),this.image.onload=this.image.onerror=n,this.image.src=a[1],this.text=null):this.update()});0==d&&g(!0)}else g(!1)}};
