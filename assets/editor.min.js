function Editor(a){function d(a){l||(e.history.change(e.selected.items(),["x","y"]),l=!0);var b=a.x-g.x,d=a.y-g.y;keyModeShift&&(10<Math.abs(b)||10<Math.abs(d))&&(Math.abs(b)>Math.abs(d)?d=0:b=0);e.selected.each(function(){this.x=this.old.x+b;this.y=this.old.y+d});e.markers.update();e.update()}function b(a){l||(e.history.change(e.selected.items(),["x","y","width","height"]),l=!0);var b=a.x-k.x,d=a.y-k.y;keyModeShift&&(10<Math.abs(b)||10<Math.abs(d))&&(Math.abs(b)>Math.abs(d)?d=Math.abs(b)*(d/b):b=
Math.abs(d)*(b/d));e.selected.each(function(){if(2==h||4==h||7==h)this.width=this.old.width+b*this.old.rw,10>this.width&&(this.width=10),this.x=this.old.x+b*(1-this.old.rx);else if(0==h||3==h||5==h)this.width=this.old.width-b*this.old.rx,10>this.width?this.width=10:this.x=this.old.x+b*this.old.rx;if(5==h||6==h||7==h)this.height=this.old.height+d*this.old.rh,10>this.height&&(this.height=10),this.y=this.old.y+d*(1-this.old.ry);else if(0==h||1==h||2==h)this.height=this.old.height-d*this.old.rh,10>this.height?
this.height=10:this.y=this.old.y+d*this.old.ry;this.updateTextLines(e.context)});e.markers.update();e.update()}function c(){e.selected.each(function(){this.updateOld()})}function f(){e.context.clearRect(0,0,e.canvas.width,e.canvas.height);e.objects.each(function(){this.draw(e.context)})}this.objects=new EditorGroup;this.selected=new EditorGroup;this.selectedObject=null;this.markers=new Markers(this);this.history=new EditorHistory(this);this.fn=new EditorFunctions(this);this.canvas=document.getElementById("paper"+
a);this.context=this.canvas.getContext("2d");this.showFrame=!0;this.printMode=!1;var g=this.onObjectChange=null,h=null,k=null,l=!1,e=this;this.selectObject=function(a){e.selected.add(a);e.markers.update();1==e.selected.count()?e.selectedObject=e.selected.item(0):e.selectedObject=null};this.unselectAll=function(){this.selected.count()&&(this.selected.clear(),this.markers.update(),e.selectedObject=null)};this.print=function(){this.printMode=!0;f();this.printMode=!1};this.draw=function(){f();e.markers.draw()};
this.update=function(){this.draw();this.onObjectChange.call(this)};this.canvas.onmousemove=function(a){var c=e.fn.windowToCanvas(a.clientX,a.clientY);if(g)d(c);else if(k)b(c);else{a=e.canvas.style.cursor;var l="default",f=e.markers.testPoint(c);null===f?e.objects.each(function(){if(this.testPoint(c))return l="move",!1}):l=e.markers.cursors[f];l!=a&&(e.canvas.style.cursor=l)}};this.canvas.onmouseup=function(a){if(k)k=null;else{var b=e.fn.windowToCanvas(a.clientX,a.clientY);if(g){a=b.x-g.x;var d=b.y-
g.y;g=null;if(5<Math.abs(a)||5<Math.abs(d))return}var c=!1;e.objects.reverseEach(function(){if(this.testPoint(b)){c=!0;if(keyModeCtrl){if(e.selected.remove(this))return e.markers.update(),!1}else e.unselectAll();e.selectObject(this);return!1}});c||keyModeCtrl||e.unselectAll();e.onObjectChange.call(this);e.draw()}};this.canvas.onmousedown=function(a){if(null===g){var b=e.fn.windowToCanvas(a.clientX,a.clientY);a=e.markers.testPoint(b);null!==a?(c(),h=a,k=b,l=!1):e.selected.each(function(){if(this.testPoint(b))return c(),
g=b,l=!1})}}};var EditorFunctions=function(a){var d=function(a){"string"===typeof a&&(a=parseFloat(a.replace(",",".")));return a};this.toUnit=function(a){return d(a)/37.795};this.fromUnit=function(a){return 37.795*parseFloat(d(a))};this.windowToCanvas=function(b,d){var f=a.canvas.getBoundingClientRect();return{x:b-a.canvas.width/f.width*f.left,y:d-a.canvas.height/f.height*f.top}};this.clone=function(){if(a.selected.count()){var b=[];a.selected.each(function(){var a=this.clone();a.x+=20;a.y+=20;a.update();b.push(a)});
a.history.create(b);a.unselectAll();for(var d=0,f=b.length;d<f;d++)a.selectObject(b[d]);a.update()}};this.remove=function(){a.selected.count()&&(a.history.remove(a.selected.items()),a.selected.each(function(){a.objects.remove(this)}),a.unselectAll(),a.update())};this.align=function(){if(a.selected.count()){var b=a.selected.item(0),d=$(this).data("prop");a.history.change(a.selected.items(),["x","y"]);a.selected.each(function(){switch(d){case "left":this.x=b.x;break;case "center":this.x=b.x+b.width/
2-this.width/2;break;case "right":this.x=b.x+b.width-this.width;break;case "top":this.y=b.y;break;case "middle":this.y=b.y+b.height/2-this.height/2;break;case "bottom":this.y=b.y+b.height-this.height}});a.markers.update();a.update()}}};function EditorGroup(){var a=[];this.add=function(d){a.push(d)};this.remove=function(d){for(var b=0,c=a.length;b<c;b++)if(d==a[b])return a.splice(b,1),b;return null};this.item=function(d){return a[d]};this.items=function(){return a};this.clear=function(){a=[]};this.count=function(){return a.length};this.each=function(d){for(var b=0,c=a.length;b<c&&!1!==d.call(a[b]);b++);};this.reverseEach=function(d){for(var b=a.length-1;0<=b&&!1!==d.call(a[b]);b--);}};function EditorHistory(a){var d=[],b=0,c=this;this.enableRedo=this.enableUndo=!1;this.onChange=null;var f=function(a,e,f){d[b]={operation:a,objects:e};if(f){a=[];for(var g=f.length,h=0,k=e.length;h<k;h++)for(var m=0;m<g;m++)e[h].hasOwnProperty(f[m])&&(a[f[m]]=e[h][f[m]]);d[b].props=a}100==d.length?(100).splice(0,1):b++;c.enableUndo=!0;c.onChange&&c.onChange.call(c)};this.change=function(a,b){f(0,a,b)};this.create=function(a){f(1,a)};this.remove=function(a){f(2,a)};var g=function(){var c,e,f=d[b].objects,
g=f.length,h=d[b].props;for(c=0;c<g;c++){for(var k in h)e=f[c][k],f[c][k]=h[k],h[k]=e;f[c].update();a.selectObject(f[c])}},h=function(){var c,e=d[b].objects,f=e.length;for(c=0;c<f;c++)a.objects.add(e[c]),a.selectObject(e[c])},k=function(){var c,e=d[b].objects,f=e.length;for(c=0;c<f;c++)a.objects.remove(e[c])};this.undo=function(){if(0<b){b--;a.unselectAll();switch(d[b].operation){case 0:g();break;case 1:k();break;case 2:h()}a.markers.update();a.update();c.enableUndo=0<b;c.enableRedo=!0;c.onChange&&
c.onChange.call(c)}};this.redo=function(){if(b<d.length){a.unselectAll();switch(d[b].operation){case 0:g();break;case 1:h();break;case 2:k()}a.markers.update();a.update();b++;c.enableUndo=!0;c.enableRedo=b<d.length;c.onChange&&c.onChange.call(c)}}};var editor,keyModeCtrl,keyModeShift,isChange=!1;function showNoty(a){return noty({text:a.text,theme:"defaultTheme",layout:a.layout?a.layout:"bottomLeft",type:a.type?a.type:"information",dismissQueue:!1,timeout:a.timeout?a.timeout:1400,modal:a.modal?a.modal:!1,closeWith:a.modal?[]:["click"],force:!0,killer:!0})}showNoty({text:"\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430...",theme:"defaultTheme",layout:"topCenter",type:"success",timeout:!1});
jQuery.fn.disableSelection=function(){this.each(function(){this.onselectstart=function(){return!1};this.unselectable="on";jQuery(this).css({"-moz-user-select":"none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"});jQuery(this).bind("mousedown",function(){return!1})})};jQuery.fn.disabled=function(a){$(this).each(function(){a?$(this).attr("disabled","disabled"):$(this).removeAttr("disabled")});return $(this)};
function changeObjectColor(){if(editor.selectedObject){var a=$(this),d=a.data("te-prop");"undefined"===typeof d&&(d=a.parent().next("input").data("te-prop"));editor.selectedObject[d]=a.val();editor.update()}}
$(function(){function a(a){if(editor.selectedObject){var b;$(this).hasClass("active")?(b=!1,$(this).removeClass("active")):(b=!0,$(this).addClass("active"));editor.history.change([editor.selectedObject],[a.data.param]);editor.selectedObject[a.data.param]=b;editor.selectedObject.updateFont();editor.update()}}var d=$("#te-btn-save"),b=$("#te-btn-print"),c=$("#save-config"),f=$("#te-btn-copy"),g=$("#te-btn-create"),h=$("#te-btn-undo"),k=$("#te-btn-redo"),l=$("#te-btn-delete"),e=$("#te-text"),p=$("#te-templates"),
n=$("#te-font"),q=$("#te-btn-bold"),r=$("#te-btn-italic"),m=$(".align"),z=$(".m-align"),x=$("[data-te-size-prop]"),y=$("[data-te-prop]"),t=$(".valign");editor=new Editor(0);editor.onObjectChange=function(a){editor.selectedObject?($(".only-select").disabled(!1),x.each(function(){var a=editor.selectedObject[$(this).data("te-size-prop")];$(this).val(editor.fn.toUnit(a).toFixed(2))}),a||(y.each(function(){var a=$(this).data("te-prop"),b=editor.selectedObject[a];null==b&&"fillStyle"==a||$(this).val(b)}),
e.val(editor.selectedObject.getText()),m.removeClass("active"),$('.align[data-te-prop="'+editor.selectedObject.textAlign+'"]').addClass("active"),t.each(function(){$(this).parent().removeClass("active")}),$('.valign[data-te-prop="'+editor.selectedObject.textBaseline+'"]').parent().addClass("active"),editor.selectedObject.fontBold?q.addClass("active"):q.removeClass("active"),editor.selectedObject.fontItalic?r.addClass("active"):r.removeClass("active"))):($(".only-select, .only-select2").disabled(!0),
1<editor.selected.count()&&$(".only-select2").disabled(!1))};editor.history.onChange=function(){isChange=!0;d.disabled(!1);h.disabled(!this.enableUndo);k.disabled(!this.enableRedo)};g.click(function(){var a=new EditorObject(editor);a.text="\u0422\u0435\u043a\u0441\u0442";a.width=a.height=150;a.x=editor.canvas.width/2-a.width/2;a.y=editor.canvas.height/2-a.height/2;a.update();editor.history.create([a]);editor.unselectAll();editor.selectObject(a);editor.update()});b.click(function(){(new EditorPrinter([editor],
!0)).print();keyModeShift=keyModeCtrl=null});$("#te-btn-close").click(function(){if(!isChange||confirm("\u0412\u044b \u0441\u043e\u0431\u0438\u0440\u0430\u0435\u0442\u0435\u0441\u044c \u0443\u0439\u0442\u0438 \u0441\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b. \u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u0431\u0443\u0434\u0443\u0442 \u043f\u043e\u0442\u0435\u0440\u044f\u043d\u044b. \u0423\u0439\u0442\u0438?"))location.href=$(this).data("url")});c.click(function(){var a=$("#form-config");
$("#modal-config").modal("hide");$.post(a.attr("action"),a.serialize(),function(a){a.result?(editor.canvas.width=editor.fn.fromUnit($("#template-width").val()),editor.canvas.height=editor.fn.fromUnit($("#template-height").val()),editor.update()):$("#modal-config").modal("show");showNoty({text:a.message,type:a.result?"success":"error"})})});d.click(function(){var a=new Serialize,a={id:templateData.id,objects:a.save(editor.objects)},b=showNoty({text:"\u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435...",
theme:"defaultTheme",timeout:!1});$.post(templateData.saveUrl,a,function(a){b.setText(a.message);b.setType(a.result?"success":"error");d.disabled(!0);isChange=!1})});h.click(editor.history.undo);k.click(editor.history.redo);l.click(editor.fn.remove);f.click(editor.fn.clone);y.change(function(){if(editor.selectedObject){var a=$(this).attr("data-te-prop"),b=$(this).val();$(this).attr("data-unit")&&(b=editor.fn.fromUnit(b));editor.history.change([editor.selectedObject],[a]);editor.selectedObject[a]=
b;editor.selectedObject.update();editor.markers.update(editor.selected);editor.draw()}});x.change(function(){if(editor.selectedObject){var a=$(this).attr("data-te-size-prop");editor.history.change([editor.selectedObject],[a]);editor.selectedObject[a]=editor.fn.fromUnit($(this).val());editor.selectedObject.update();editor.markers.update(editor.selected);editor.draw()}});var v=!1,w=!1;e.bind("keyup change",function(){editor.selectedObject&&(v&&!w&&(editor.history.change([editor.selectedObject],["text"]),
w=!0),editor.selectedObject.setText($(this).val()),editor.draw())}).focus(function(){v=!0;w=!1}).blur(function(){v=!1});p.dblclick(function(){editor.selectedObject&&(e.val(e.val()+$(this).val()),e.change())});t.click(function(){editor.selectedObject&&(editor.selectedObject.textBaseline=$(this).data("te-prop"),editor.selectedObject.updateTextLines(),editor.update(),t.each(function(){$(this).parent().removeClass("active")}),$(this).parent().addClass("active"))});n.change(function(){editor.selectedObject&&
(editor.history.change([editor.selectedObject],["fontFamily"]),editor.selectedObject.fontFamily=$(this).val(),editor.selectedObject.updateTextLines(),editor.update())});q.click({param:"fontBold"},a);r.click({param:"fontItalic"},a);m.click(function(){editor.selectedObject&&(editor.history.change([editor.selectedObject],["textAlign"]),editor.selectedObject.textAlign=$(this).data("te-prop"),editor.update(),m.removeClass("active"),$(this).addClass("active"));return!1});t.click(function(){editor.selectedObject&&
(editor.history.change([editor.selectedObject],["textBaseline"]),editor.selectedObject.textBaseline=$(this).data("te-prop"),editor.update(),t.each(function(){$(this).parent().removeClass("active")}),$(this).parent().addClass("active"));return!1});z.click(editor.fn.align);var u=$(".middle");u.length&&(c=function(){var a=$(window).height()-u.offset().top;u.height(a)},$(window).resize(c),c());u.disableSelection();$(".only-select").disabled(!0);d.disabled(!0);$(document).keydown(function(a){keyModeCtrl=
a.ctrlKey;keyModeShift=a.shiftKey;if(a.ctrlKey)switch(String.fromCharCode(a.which).toLowerCase()){case "s":a.preventDefault();d.click();break;case "p":a.preventDefault();b.click();break;case "d":a.preventDefault();f.click();break;case "z":a.shiftKey?k.click():h.click();a.preventDefault();break;case "b":q.click();break;case "i":r.click()}}).keyup(function(a){keyModeCtrl=a.ctrlKey;keyModeShift=a.shiftKey;switch(a.which){case 46:(!this.activeElement||"TEXTAREA"!=this.activeElement.nodeName&&"INPUT"!=
this.activeElement.nodeName)&&l.click()}});var A="1"==$("#fast-print").val();$.get(templateData.loadUrl,function(a){(new Serialize).load(a.items,editor,function(a){a.state&&($.noty.closeAll(),A?(new EditorPrinter(a.editors,!1)).print():editor.update())})})});function Markers(a){this.height=this.width=this.y=this.x=0;var d=!1,b=[],c=this;this.cursors="nw-resize n-resize sw-resize w-resize w-resize sw-resize n-resize nw-resize".split(" ");this.update=function(){if(0==a.selected.count())d=!1;else{d=!0;var f=0,g=0;c.x=Infinity;c.y=Infinity;a.selected.each(function(){c.x>this.x&&(c.x=this.x);c.y>this.y&&(c.y=this.y);f<this.x+this.width&&(f=this.x+this.width);g<this.y+this.height&&(g=this.y+this.height)});this.width=f-this.x;this.height=g-this.y;b[0]={x:this.x-
6,y:this.y-6};b[1]={x:this.x+this.width/2-3,y:this.y-6};b[2]={x:this.x+this.width,y:this.y-6};b[3]={x:this.x-6,y:this.y+this.height/2-3};b[4]={x:this.x+this.width,y:this.y+this.height/2-3};b[5]={x:this.x-6,y:this.y+this.height};b[6]={x:this.x+this.width/2-3,y:this.y+this.height};b[7]={x:this.x+this.width,y:this.y+this.height}}};this.testPoint=function(a){if(d)for(var c=0;8>c;c++)if(a.x>b[c].x&&a.y>b[c].y&&a.x<b[c].x+6&&a.y<b[c].y+6)return c;return null};this.draw=function(){if(d){a.context.fillStyle=
"#337AB7";for(var c=0;8>c;c++)a.context.fillRect(b[c].x,b[c].y,6,6)}}};function EditorObject(a){this.lineWidth=this.height=this.width=this.y=this.x=0;this.strokeStyle="#000000";this.fillStyle=null;this.textStyle="#000000";this.textAlign="center";this.textBaseline="middle";this.lineHeight=25;this.fontFamily="Arial";this.fontSize=16;this.fontItalic=this.fontBold=!1;this.image=this.text=null;this.old={};this.font="";this.lines=[];this.textHeight=0;a.objects.add(this);this.clone=function(){var d=new EditorObject(a),b;for(b in this)d.hasOwnProperty(b)&&(d[b]=this[b]);return d};
this.testPoint=function(a){return a.x>this.x&&a.y>this.y&&a.x<this.x+this.width&&a.y<this.y+this.height};this.updateOld=function(){this.old.x=this.x;this.old.y=this.y;this.old.width=this.width;this.old.height=this.height;this.old.rx=a.markers.x/this.x;this.old.rw=this.width/a.markers.width;this.old.ry=a.markers.y/this.y;this.old.rh=this.height/a.markers.height};this.setText=function(a){this.text=a;this.updateTextLines()};this.getText=function(){return this.text};this.update=function(){this.updateFont();
this.updateTextLines()};this.updateFont=function(){this.font="";this.fontItalic&&(this.font+="italic ");this.fontBold&&(this.font+="bold ");this.lineHeight=1.4*this.fontSize;this.font+=this.fontSize+"pt "+this.fontFamily};this.updateTextLines=function(){this.lines=[];if(this.text&&""!=this.text){var d=this.text.split("\n"),b=d.length,c=a.context;this.textHeight=this.lineHeight*b;a.context.font=this.font;for(var f=0;f<b;f++){for(var g="",h=d[f].split(" "),k=0,l=h.length;k<l;k++){var e=g+h[k];c.measureText(e).width>
this.width-10?(this.lines.push(g),this.textHeight+=this.lineHeight,g=h[k]+" "):g=e+" "}this.lines.push(g)}this.textHeight-=this.lineHeight}};this.draw=function(){var d=a.context;this.fillStyle&&(d.fillStyle=this.fillStyle,d.fillRect(this.x,this.y,this.width,this.height));this.image&&d.drawImage(this.image,20,20,this.image.naturalWidth-40,this.image.naturalHeight-40,this.x,this.y,this.width,this.image.naturalHeight*this.width/this.image.naturalWidth);0<this.lineWidth?(d.strokeStyle=this.strokeStyle,
d.lineWidth=this.lineWidth,d.setLineDash([]),d.strokeRect(this.x,this.y,this.width,this.height)):this.fillStyle||!a.showFrame||a.printMode||(d.setLineDash([1,2]),d.strokeStyle="#888888",d.lineWidth=1,d.strokeRect(this.x,this.y,this.width,this.height));var b;if(b=this.lines.length){d.fillStyle=this.textStyle;d.font=this.font;d.textAlign=this.textAlign;d.textBaseline=this.textBaseline;var c,f;f="left"==this.textAlign?this.x:"right"==this.textAlign?this.x+this.width:this.x+this.width/2;c="top"==this.textBaseline?
this.y:"bottom"==this.textBaseline?this.y+this.height-this.textHeight:this.y+this.height/2-this.textHeight/2;for(var g=0;g<b&&!(c>=this.y&&d.fillText(this.lines[g],f,c),c+=this.lineHeight,c>this.y+this.height);g++);}}};function EditorPrinter(a,d){function b(a,b,c,d){a.document.write('<img width="'+c+'" height="'+d+'" src="'+b.canvas.toDataURL()+'">')}var c=d?window.open():window;this.print=function(){c.document.write("<head><title>NovatorPriceService</title><style>@page :first {margin: 0.5cm} @page :left { margin: 0.5cm } @page :right { margin: 0.5cm } @media print and (color) { * { -webkit-print-color-adjust: exact; print-color-adjust: exact }} body {margin:0; width:100%} img {margin:0; outline:none} table {margin: 0} table td {padding: 0}</style></head><body>");
if(1==a.length)a[0].print(),b(c,a[0],a[0].canvas.width,a[0].canvas.height);else{var f=new EditorFunctions(a[0]),f=parseInt(f.fromUnit(21)/a[0].canvas.width),g=0,h='style="width:'+a[0].canvas.width+"px;height:"+a[0].canvas.height+'px"';c.document.write("<table><tr>");for(var k=0;k<a.length;k++){c.document.write("<td "+h+">");var l=c,e=a[k],p=e.canvas.width,n=e.canvas.height;e.canvas.width=2*p;e.canvas.height=2*n;e.context.scale(2,2);e.print();b(l,e,p,n);c.document.write("</td>");g++;g>=f&&(g=0,c.document.write("</td></tr><tr>"))}c.document.write("</tr></table>")}c.document.write("</body>");
c.print();c.close();c.location.reload();d&&a[0].update()}};function Serialize(){var a="x y width height text lineWidth strokeStyle fillStyle textStyle textAlign textBaseline lineHeight fontFamily fontSize fontBold fontItalic".split(" ");this.save=function(d){var b=[],c,f=a.length;d.each(function(){var d={};for(c=0;c<f;c++)d[a[c]]=this[a[c]];b.push(d)});return JSON.stringify({version:"1.0.0",objects:b})};this.load=function(d,b,c){if(""==d)return!1;for(var f=0,g=[],h,k=0;k<d.length;k++){var l=JSON.parse(d[k]);h=0==k?b:new Editor(k);g.push(h);if(l&&l.hasOwnProperty("version")&&
l.hasOwnProperty("objects")&&"1.0.0"==l.version){var l=l.objects,e=a.length,p,n,q;p=0;for(q=l.length;p<q;p++){var r=new EditorObject(h);for(n=0;n<e;n++)r[a[n]]=l[p][a[n]]}var m=function(){f--;0==f&&c({state:!0,editors:g})};h.objects.each(function(){var a=/\[image:(.*)\]/.exec(this.text);a?(f++,this.image=new Image,-1!=a[1].indexOf("http")&&(this.image.crossOrigin=""),this.image.onload=this.image.onerror=m,this.image.src=a[1],this.text=null):this.update()})}else c(!1)}0==f&&c({state:!0,editors:g})}}
;
