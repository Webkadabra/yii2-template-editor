function Editor(){function a(a){l||(d.history.change(d.selected.items(),["x","y"]),l=!0);var b=a.x-k.x,c=a.y-k.y;keyModeShift&&(10<Math.abs(b)||10<Math.abs(c))&&(Math.abs(b)>Math.abs(c)?c=0:b=0);d.selected.each(function(){this.x=this.old.x+b;this.y=this.old.y+c});d.markers.update();d.update()}function c(a){l||(d.history.change(d.selected.items(),["x","y","width","height"]),l=!0);var b=a.x-m.x,c=a.y-m.y;keyModeShift&&(10<Math.abs(b)||10<Math.abs(c))&&(Math.abs(b)>Math.abs(c)?c=Math.abs(b)*(c/b):b=
Math.abs(c)*(b/c));d.selected.each(function(){if(2==h||4==h||7==h)this.width=this.old.width+b*this.old.rw,5>this.width&&(this.width=5),this.x=this.old.x+b*(1-this.old.rx);else if(0==h||3==h||5==h)this.width=this.old.width-b*this.old.rx,5>this.width?this.width=5:this.x=this.old.x+b*this.old.rx;if(5==h||6==h||7==h)this.height=this.old.height+c*this.old.rh,5>this.height&&(this.height=5),this.y=this.old.y+c*(1-this.old.ry);else if(0==h||1==h||2==h)this.height=this.old.height-c*this.old.rh,5>this.height?
this.height=5:this.y=this.old.y+c*this.old.ry;this.updateTextLines(d.context)});d.markers.update();d.update()}function b(){d.selected.each(function(){this.updateOld()})}function e(){d.objects.each(function(){this.draw(d.context)})}this.objects=new EditorGroup;this.selected=new EditorGroup;this.selectedObject=null;this.markers=new Markers(this);this.history=new EditorHistory(this);this.fn=new EditorFunctions(this);this.context=this.canvas=null;this.showMargin=this.showFrame=!0;this.printMode=!1;this.zoom=
1;this.onObjectChange=null;var f,g,k=null,h=null,m=null,l=!1,d=this;this.setCanvas=function(e){d.canvas=e;d.context=this.canvas.getContext("2d");f=d.canvas.width;g=d.canvas.height;d.canvas.onmousemove=function(b){var e=d.fn.windowToCanvas(b.clientX,b.clientY);if(k)a(e);else if(m)c(e);else{b=d.canvas.style.cursor;var f="default",g=d.markers.testPoint(e);null===g?d.objects.each(function(){if(this.testPoint(e))return f="move",!1}):f=d.markers.cursors[g];f!=b&&(d.canvas.style.cursor=f)}};d.canvas.onmouseup=
function(a){if(m)m=null;else{var b=d.fn.windowToCanvas(a.clientX,a.clientY);if(k){a=b.x-k.x;var c=b.y-k.y;k=null;if(5<Math.abs(a)||5<Math.abs(c))return}var e=!1;d.objects.reverseEach(function(){if(this.testPoint(b)){e=!0;if(keyModeCtrl){if(d.selected.remove(this))return d.markers.update(),!1}else d.unselectAll();d.selectObject(this);return!1}});e||keyModeCtrl||d.unselectAll();d.onObjectChange.call(this);d.draw()}};d.canvas.onmousedown=function(a){if(null===k){var c=d.fn.windowToCanvas(a.clientX,a.clientY);
a=d.markers.testPoint(c);null!==a?(b(),h=a,m=c,l=!1):d.selected.each(function(){if(this.testPoint(c))return b(),k=c,l=!1})}}};this.setZoom=function(a){d.zoom=a;d.canvas.width=f*d.zoom;d.canvas.height=g*d.zoom;d.draw()};this.selectObject=function(a){d.selected.add(a);d.markers.update();1==d.selected.count()?d.selectedObject=d.selected.item(0):d.selectedObject=null};this.unselectAll=function(){this.selected.count()&&(this.selected.clear(),this.markers.update(),d.selectedObject=null)};this.print=function(){this.printMode=
!0;e();this.printMode=!1};this.draw=function(){d.context.clearRect(0,0,d.canvas.width,d.canvas.height);if(d.showMargin){d.context.strokeStyle="rgb(68, 220, 255)";d.context.setLineDash([10]);d.context.lineWidth=1;var a=d.fn.fromUnit(.5);d.context.rect(a,a,d.canvas.width-2*a,d.canvas.height-2*a);d.context.stroke();var a=d.canvas.width/2,b=d.canvas.height/2;d.context.moveTo(a,0);d.context.lineTo(a,d.canvas.height);d.context.stroke();d.context.moveTo(0,b);d.context.lineTo(d.canvas.width,b);d.context.stroke()}e();
d.markers.draw()};this.update=function(){this.draw();this.onObjectChange.call(this)}};var EditorFunctions=function(a){var c=function(a){"string"===typeof a&&(a=parseFloat(a.replace(",",".")));return a};this.toUnit=function(a){return c(a)/37.795};this.fromUnit=function(a){return 37.795*parseFloat(c(a))};this.windowToCanvas=function(b,c){var f=a.canvas.getBoundingClientRect();return{x:(b-a.canvas.width/f.width*f.left)/a.zoom,y:(c-a.canvas.height/f.height*f.top)/a.zoom}};this.clone=function(){if(a.selected.count()){var b=[];a.selected.each(function(){var a=this.clone();a.x+=20;a.y+=20;
a.update();b.push(a)});a.history.create(b);a.unselectAll();for(var c=0,f=b.length;c<f;c++)a.selectObject(b[c]);a.update()}};this.remove=function(){a.selected.count()&&(a.history.remove(a.selected.items()),a.selected.each(function(){a.objects.remove(this)}),a.unselectAll(),a.update())};this.align=function(){if(a.selected.count()){var b=a.selected.item(0),c=$(this).data("prop");a.history.change(a.selected.items(),["x","y"]);a.selected.each(function(){switch(c){case "left":this.x=b.x;break;case "center":this.x=
b.x+b.width/2-this.width/2;break;case "right":this.x=b.x+b.width-this.width;break;case "top":this.y=b.y;break;case "middle":this.y=b.y+b.height/2-this.height/2;break;case "bottom":this.y=b.y+b.height-this.height}});a.markers.update();a.update()}};this.insertImage=function(b){if(1==a.selected.count()){var c=a.selected.item(0);c.image=new Image;c.image.onload=c.image.onerror=function(){c.text="";c.update();a.update();a.history.change([a.selectedObject],["text"])};c.image.src=b.url}}};function EditorGroup(){var a=[];this.add=function(c){a.push(c)};this.remove=function(c){for(var b=0,e=a.length;b<e;b++)if(c==a[b])return a.splice(b,1),b;return null};this.item=function(c){return a[c]};this.items=function(){return a};this.clear=function(){a=[]};this.count=function(){return a.length};this.each=function(c){for(var b=0,e=a.length;b<e&&!1!==c.call(a[b]);b++);};this.reverseEach=function(c){for(var b=a.length-1;0<=b&&!1!==c.call(a[b]);b--);}};function EditorHistory(a){var c=[],b=0,e=this;this.enableRedo=this.enableUndo=!1;this.onChange=null;var f=function(a,f,d){c[b]={operation:a,objects:f};if(d){a=[];for(var g=d.length,h=0,k=f.length;h<k;h++)for(var n=0;n<g;n++)f[h].hasOwnProperty(d[n])&&(a[d[n]]=f[h][d[n]]);c[b].props=a}100==c.length?(100).splice(0,1):b++;e.enableUndo=!0;e.onChange&&e.onChange.call(e)};this.change=function(a,b){f(0,a,b)};this.create=function(a){f(1,a)};this.remove=function(a){f(2,a)};var g=function(){var e,f,d=c[b].objects,
g=d.length,h=c[b].props;for(e=0;e<g;e++){for(var k in h)f=d[e][k],d[e][k]=h[k],h[k]=f;d[e].update();a.selectObject(d[e])}},k=function(){var e,f=c[b].objects,d=f.length;for(e=0;e<d;e++)a.objects.add(f[e]),a.selectObject(f[e])},h=function(){var e,f=c[b].objects,d=f.length;for(e=0;e<d;e++)a.objects.remove(f[e])};this.undo=function(){if(0<b){b--;a.unselectAll();switch(c[b].operation){case 0:g();break;case 1:h();break;case 2:k()}a.markers.update();a.update();e.enableUndo=0<b;e.enableRedo=!0;e.onChange&&
e.onChange.call(e)}};this.redo=function(){if(b<c.length){a.unselectAll();switch(c[b].operation){case 0:g();break;case 1:k();break;case 2:h()}a.markers.update();a.update();b++;e.enableUndo=!0;e.enableRedo=b<c.length;e.onChange&&e.onChange.call(e)}}};var editor,keyModeCtrl,keyModeShift,isChange=!1;function showNoty(a){return noty({text:a.text,theme:"defaultTheme",layout:a.layout?a.layout:"bottomLeft",type:a.type?a.type:"information",dismissQueue:!1,timeout:a.timeout?a.timeout:1400,modal:a.modal?a.modal:!1,closeWith:a.modal?[]:["click"],force:!0,killer:!0})}showNoty({text:"\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430...",theme:"defaultTheme",layout:"topCenter",type:"success",timeout:!1});
jQuery.fn.disableSelection=function(){this.each(function(){this.onselectstart=function(){return!1};this.unselectable="on";jQuery(this).css({"-moz-user-select":"none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"});jQuery(this).bind("mousedown",function(){return!1})})};jQuery.fn.disabled=function(a){$(this).each(function(){a?$(this).attr("disabled","disabled"):$(this).removeAttr("disabled")});return $(this)};
function changeObjectColor(){if(editor.selectedObject){var a=$(this),c=a.data("te-prop");"undefined"===typeof c&&(c=a.parent().next("input").data("te-prop"));editor.selectedObject[c]=a.val();editor.update()}}
$(function(){function a(a){if(editor.selectedObject){var b;$(this).hasClass("active")?(b=!1,$(this).removeClass("active")):(b=!0,$(this).addClass("active"));editor.history.change([editor.selectedObject],[a.data.param]);editor.selectedObject[a.data.param]=b;editor.selectedObject.updateFont();editor.update()}}function c(){$("#zoom-value").text((100*parseFloat(u.val())).toFixed()+"%")}var b=$("#te-btn-save"),e=$("#te-btn-print"),f=$("#save-config"),g=$("#te-btn-copy"),k=$("#te-btn-create"),h=$("#te-btn-undo"),
m=$("#te-btn-redo"),l=$("#te-btn-delete"),d=$("#te-text"),t=$("#te-templates"),B=$("#te-font"),r=$("#te-btn-bold"),n=$("#te-btn-italic"),C=$("#te-btn-frames"),D=$("#te-btn-margin"),v=$(".align"),E=$(".m-align"),y=$("[data-te-size-prop]"),z=$("[data-te-prop]"),p=$(".valign");editor=new Editor;editor.setCanvas(document.getElementById("paper"));editor.onObjectChange=function(a){editor.selectedObject?($(".only-select").disabled(!1),y.each(function(){var a=editor.selectedObject[$(this).data("te-size-prop")];
$(this).val(editor.fn.toUnit(a).toFixed(2))}),a||(z.each(function(){var a=$(this).data("te-prop"),b=editor.selectedObject[a];null==b&&"fillStyle"==a||$(this).val(b)}),d.val(editor.selectedObject.getText()),v.removeClass("active"),$('.align[data-te-prop="'+editor.selectedObject.textAlign+'"]').addClass("active"),p.each(function(){$(this).parent().removeClass("active")}),$('.valign[data-te-prop="'+editor.selectedObject.textBaseline+'"]').parent().addClass("active"),editor.selectedObject.fontBold?r.addClass("active"):
r.removeClass("active"),editor.selectedObject.fontItalic?n.addClass("active"):n.removeClass("active"))):($(".only-select, .only-select2").disabled(!0),1<editor.selected.count()&&$(".only-select2").disabled(!1))};editor.history.onChange=function(){isChange=!0;b.disabled(!1);h.disabled(!this.enableUndo);m.disabled(!this.enableRedo)};k.click(function(){var a=new EditorObject(editor);a.text="";a.width=a.height=150;a.x=editor.canvas.width/2-a.width/2;a.y=editor.canvas.height/2-a.height/2;a.update();editor.history.create([a]);
editor.unselectAll();editor.selectObject(a);editor.update()});e.click(function(){(new EditorPrinter([editor],!0)).print();keyModeShift=keyModeCtrl=null});$("#te-btn-close").click(function(){if(!isChange||confirm("\u0412\u044b \u0441\u043e\u0431\u0438\u0440\u0430\u0435\u0442\u0435\u0441\u044c \u0443\u0439\u0442\u0438 \u0441\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b. \u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u0431\u0443\u0434\u0443\u0442 \u043f\u043e\u0442\u0435\u0440\u044f\u043d\u044b. \u0423\u0439\u0442\u0438?"))location.href=
$(this).data("url")});f.click(function(){var a=$("#form-config");$("#modal-config").modal("hide");$.post(a.attr("action"),a.serialize(),function(a){a.result?(editor.canvas.width=editor.fn.fromUnit($("#template-width").val()),editor.canvas.height=editor.fn.fromUnit($("#template-height").val()),editor.update()):$("#modal-config").modal("show");showNoty({text:a.message,type:a.result?"success":"error"})})});b.click(function(){var a=new Serialize,a={id:templateData.id,objects:a.save(editor.objects)},c=
showNoty({text:"\u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435...",theme:"defaultTheme",timeout:!1});$.post(templateData.saveUrl,a,function(a){c.setText(a.message);c.setType(a.result?"success":"error");b.disabled(!0);isChange=!1})});h.click(editor.history.undo);m.click(editor.history.redo);l.click(editor.fn.remove);g.click(editor.fn.clone);C.click(function(){$(this).toggleClass("active");editor.showFrame=$(this).hasClass("active");editor.draw();return!0});D.click(function(){$(this).toggleClass("active");
editor.showMargin=$(this).hasClass("active");editor.draw();return!0});z.change(function(){if(editor.selectedObject){var a=$(this).attr("data-te-prop"),b=$(this).val();$(this).attr("data-unit")&&(b=editor.fn.fromUnit(b));editor.history.change([editor.selectedObject],[a]);editor.selectedObject[a]=b;editor.selectedObject.update();editor.markers.update(editor.selected);editor.draw()}});y.change(function(){if(editor.selectedObject){var a=$(this).attr("data-te-size-prop");editor.history.change([editor.selectedObject],
[a]);editor.selectedObject[a]=editor.fn.fromUnit($(this).val());editor.selectedObject.update();editor.markers.update(editor.selected);editor.draw()}});var w=!1,x=!1;d.bind("keyup change",function(){editor.selectedObject&&(w&&!x&&(editor.history.change([editor.selectedObject],["text"]),x=!0),editor.selectedObject.setText($(this).val()),editor.draw())}).focus(function(){w=!0;x=!1}).blur(function(){w=!1});t.dblclick(function(){editor.selectedObject&&(d.val(d.val()+$(this).val()),d.change())});var A=
!1;$("#add-img").click(function(){if(editor.selectedObject){var a=$("#modal-elfinder");a.modal();A||$.get(a.data("url"),function(b){a.find(".modal-body").html(b);A=!0})}return!1});p.click(function(){editor.selectedObject&&(editor.selectedObject.textBaseline=$(this).data("te-prop"),editor.selectedObject.updateTextLines(),editor.update(),p.each(function(){$(this).parent().removeClass("active")}),$(this).parent().addClass("active"))});B.change(function(){editor.selectedObject&&(editor.history.change([editor.selectedObject],
["fontFamily"]),editor.selectedObject.fontFamily=$(this).val(),editor.selectedObject.updateTextLines(),editor.update())});r.click({param:"fontBold"},a);n.click({param:"fontItalic"},a);v.click(function(){editor.selectedObject&&(editor.history.change([editor.selectedObject],["textAlign"]),editor.selectedObject.textAlign=$(this).data("te-prop"),editor.update(),v.removeClass("active"),$(this).addClass("active"));return!1});p.click(function(){editor.selectedObject&&(editor.history.change([editor.selectedObject],
["textBaseline"]),editor.selectedObject.textBaseline=$(this).data("te-prop"),editor.update(),p.each(function(){$(this).parent().removeClass("active")}),$(this).parent().addClass("active"));return!1});E.click(editor.fn.align);var u=$("#zoom");u.change(function(){editor.setZoom($(this).val());c()});$("#zoom100").click(function(){editor.setZoom(1);u.val(1);c()});var q=$(".middle");q.length&&(f=function(){var a=$(window).height()-q.offset().top,b=$(window).width()-($(".left").width()+$(".right").width());
q.height(a);q.width(b)},$(window).resize(f),f());q.disableSelection();$(".only-select").disabled(!0);b.disabled(!0);$(document).keydown(function(a){keyModeCtrl=a.ctrlKey;keyModeShift=a.shiftKey;if(a.ctrlKey)switch(String.fromCharCode(a.which).toLowerCase()){case "s":a.preventDefault();b.click();break;case "p":a.preventDefault();e.click();break;case "d":a.preventDefault();g.click();break;case "z":a.shiftKey?m.click():h.click();a.preventDefault();break;case "b":r.click();break;case "i":n.click()}}).keyup(function(a){keyModeCtrl=
a.ctrlKey;keyModeShift=a.shiftKey;switch(a.which){case 46:(!this.activeElement||"TEXTAREA"!=this.activeElement.nodeName&&"INPUT"!=this.activeElement.nodeName)&&l.click()}});$.get(templateData.loadUrl,function(a){var b=new Serialize(editor);b.callback=function(a){a&&($.noty.closeAll(),editor.update())};b.load(a)})});function Markers(a){this.height=this.width=this.y=this.x=0;var c=!1,b=[],e=this;this.cursors="nw-resize n-resize sw-resize w-resize w-resize sw-resize n-resize nw-resize".split(" ");this.update=function(){if(0==a.selected.count())c=!1;else{c=!0;var f=0,g=0;e.x=Infinity;e.y=Infinity;a.selected.each(function(){e.x>this.x&&(e.x=this.x);e.y>this.y&&(e.y=this.y);f<this.x+this.width&&(f=this.x+this.width);g<this.y+this.height&&(g=this.y+this.height)});this.width=f-this.x;this.height=g-this.y;b[0]={x:this.x-
6,y:this.y-6};b[1]={x:this.x+this.width/2-3,y:this.y-6};b[2]={x:this.x+this.width,y:this.y-6};b[3]={x:this.x-6,y:this.y+this.height/2-3};b[4]={x:this.x+this.width,y:this.y+this.height/2-3};b[5]={x:this.x-6,y:this.y+this.height};b[6]={x:this.x+this.width/2-3,y:this.y+this.height};b[7]={x:this.x+this.width,y:this.y+this.height}}};this.testPoint=function(a){if(c)for(var e=0;8>e;e++)if(a.x>b[e].x&&a.y>b[e].y&&a.x<b[e].x+6&&a.y<b[e].y+6)return e;return null};this.draw=function(){if(c){a.context.fillStyle=
"#337AB7";for(var e=0;8>e;e++)a.context.fillRect(b[e].x*a.zoom,b[e].y*a.zoom,6,6)}}};function EditorObject(a){this.lineWidth=this.height=this.width=this.y=this.x=0;this.strokeStyle="#000000";this.fillStyle=null;this.textStyle="#000000";this.textAlign="center";this.textBaseline="middle";this.lineHeight=25;this.fontFamily="Arial";this.fontSize=16;this.fontItalic=this.fontBold=!1;this.image=this.text=null;this.old={};this.font="";this.lines=[];this.textHeight=0;a.objects.add(this);this.clone=function(){var c=new EditorObject(a),b;for(b in this)c.hasOwnProperty(b)&&(c[b]=this[b]);return c};
this.testPoint=function(a){return a.x>this.x&&a.y>this.y&&a.x<this.x+this.width&&a.y<this.y+this.height};this.updateOld=function(){this.old.x=this.x;this.old.y=this.y;this.old.width=this.width;this.old.height=this.height;this.old.rx=a.markers.x/this.x;this.old.rw=this.width/a.markers.width;this.old.ry=a.markers.y/this.y;this.old.rh=this.height/a.markers.height};this.setText=function(a){this.text=a;this.updateTextLines()};this.getText=function(){return this.text};this.update=function(){this.updateFont();
this.updateTextLines()};this.updateFont=function(){this.font="";this.fontItalic&&(this.font+="italic ");this.fontBold&&(this.font+="bold ");this.lineHeight=1.5*this.fontSize;this.font+=this.fontSize+"pt "+this.fontFamily};this.updateTextLines=function(){this.lines=[];if(this.text&&""!=this.text){var c=this.text.split("\n"),b=c.length,e=a.context;this.textHeight=this.lineHeight*b;a.context.font=this.font;for(var f=0;f<b;f++){for(var g="",k=c[f].split(" "),h=0,m=k.length;h<m;h++){var l=g+k[h];e.measureText(l).width>
this.width-10?(this.lines.push(g),this.textHeight+=this.lineHeight,g=k[h]+" "):g=l+" "}this.lines.push(g)}this.textHeight-=this.lineHeight}};this.draw=function(){var c=a.context;this.fillStyle&&(c.fillStyle=this.fillStyle,c.fillRect(this.x*a.zoom,this.y*a.zoom,this.width*a.zoom,this.height*a.zoom));this.image&&c.drawImage(this.image,20,20,this.image.naturalWidth-40,this.image.naturalHeight-40,this.x*a.zoom,this.y*a.zoom,this.width*a.zoom,this.image.naturalHeight*this.width*a.zoom/this.image.naturalWidth);
0<this.lineWidth?(c.strokeStyle=this.strokeStyle,c.lineWidth=this.lineWidth*a.zoom,c.setLineDash([]),c.strokeRect(this.x*a.zoom,this.y*a.zoom,this.width*a.zoom,this.height*a.zoom)):this.fillStyle||!a.showFrame||a.printMode||(c.setLineDash([1,2]),c.strokeStyle="#888888",c.lineWidth=1,c.strokeRect(this.x*a.zoom,this.y*a.zoom,this.width*a.zoom,this.height*a.zoom));var b;if(b=this.lines.length){c.fillStyle=this.textStyle;c.font=this.fontSize*a.zoom+"pt "+this.fontFamily;c.textAlign=this.textAlign;c.textBaseline=
this.textBaseline*a.zoom;var e,f;f="left"==this.textAlign?this.x*a.zoom:"right"==this.textAlign?this.x*a.zoom+this.width*a.zoom:this.x*a.zoom+this.width*a.zoom/2;e="top"==this.textBaseline?this.y*a.zoom:"bottom"==this.textBaseline?this.y*a.zoom+this.height*a.zoom-this.textHeight*a.zoom:this.y*a.zoom+this.height*a.zoom/2-this.textHeight*a.zoom/2;for(var g=0;g<b&&!(e>=this.y*a.zoom&&c.fillText(this.lines[g],f,e),e+=this.lineHeight,e>this.y*a.zoom+this.height*a.zoom);g++);}}};function Serialize(a){function c(){f--;0==f&&g.callback(!0)}function b(a){a.each(function(){var a;(a=/\[image:(.*)\]/.exec(this.text))?(f++,this.image=new Image,-1!=a[1].indexOf("http")&&(this.image.crossOrigin=""),this.image.onload=this.image.onerror=c,this.image.src=a[1],this.text=null):this.update()})}var e="x y width height text lineWidth strokeStyle fillStyle textStyle textAlign textBaseline lineHeight fontFamily fontSize fontBold fontItalic".split(" ");this.save=function(a){var b=[],c,f=e.length;
a.each(function(){var a={};for(c=0;c<f;c++)a[e[c]]=this[e[c]];null!=this.image&&(a.text="[image:"+this.image.src+"]");b.push(a)});return JSON.stringify({version:"1.0.0",objects:b})};this.callback=null;this.editor=a;var f=0,g=this;this.load=function(a){if(""==a)return!1;if((a=JSON.parse(a))&&a.hasOwnProperty("version")&&a.hasOwnProperty("objects")&&"1.0.0"==a.version){a=a.objects;var c=e.length,m,l,d;m=0;for(d=a.length;m<d;m++){var t=new EditorObject(g.editor);for(l=0;l<c;l++)t[e[l]]=a[m][e[l]]}b(g.editor.objects)}else g.callback(!1);
0==f&&g.callback(!0)}};
