function Editor(){function a(a){h||(e.history.change(e.selected.items(),["x","y"]),h=!0);var c=a.x-g.x,b=a.y-g.y;keyModeShift&&(10<Math.abs(c)||10<Math.abs(b))&&(Math.abs(c)>Math.abs(b)?b=0:c=0);e.selected.each(function(){this.x=this.old.x+c;this.y=this.old.y+b});e.markers.update();e.update()}function b(c){h||(e.history.change(e.selected.items(),["x","y","width","height"]),h=!0);var a=c.x-k.x,b=c.y-k.y;keyModeShift&&(10<Math.abs(a)||10<Math.abs(b))&&(Math.abs(a)>Math.abs(b)?b=Math.abs(a)*(b/a):a=
Math.abs(b)*(a/b));e.selected.each(function(){if(2==f||4==f||7==f)this.width=this.old.width+a*this.old.rw,10>this.width&&(this.width=10),this.x=this.old.x+a*(1-this.old.rx);else if(0==f||3==f||5==f)this.width=this.old.width-a*this.old.rx,10>this.width?this.width=10:this.x=this.old.x+a*this.old.rx;if(5==f||6==f||7==f)this.height=this.old.height+b*this.old.rh,10>this.height&&(this.height=10),this.y=this.old.y+b*(1-this.old.ry);else if(0==f||1==f||2==f)this.height=this.old.height-b*this.old.rh,10>this.height?
this.height=10:this.y=this.old.y+b*this.old.ry;this.updateTextLines(e.context)});e.markers.update();e.update()}function c(){e.selected.each(function(){this.updateOld()})}function d(){e.context.clearRect(0,0,e.canvas.width,e.canvas.height);e.objects.each(function(){this.draw(e.context)})}this.objects=new EditorGroup;this.selected=new EditorGroup;this.selectedObject=null;this.markers=new Markers(this);this.history=new EditorHistory(this);this.fn=new EditorFunctions(this);this.context=this.canvas=null;
this.showFrame=!0;this.printMode=!1;var g=this.onObjectChange=null,f=null,k=null,h=!1,e=this;this.setCanvas=function(d){e.canvas=d;e.context=this.canvas.getContext("2d");e.canvas.onmousemove=function(c){var d=e.fn.windowToCanvas(c.clientX,c.clientY);if(g)a(d);else if(k)b(d);else{c=e.canvas.style.cursor;var f="default",l=e.markers.testPoint(d);null===l?e.objects.each(function(){if(this.testPoint(d))return f="move",!1}):f=e.markers.cursors[l];f!=c&&(e.canvas.style.cursor=f)}};e.canvas.onmouseup=function(a){if(k)k=
null;else{var c=e.fn.windowToCanvas(a.clientX,a.clientY);if(g){a=c.x-g.x;var b=c.y-g.y;g=null;if(5<Math.abs(a)||5<Math.abs(b))return}var d=!1;e.objects.reverseEach(function(){if(this.testPoint(c)){d=!0;if(keyModeCtrl){if(e.selected.remove(this))return e.markers.update(),!1}else e.unselectAll();e.selectObject(this);return!1}});d||keyModeCtrl||e.unselectAll();e.onObjectChange.call(this);e.draw()}};e.canvas.onmousedown=function(a){if(null===g){var b=e.fn.windowToCanvas(a.clientX,a.clientY);a=e.markers.testPoint(b);
null!==a?(c(),f=a,k=b,h=!1):e.selected.each(function(){if(this.testPoint(b))return c(),g=b,h=!1})}}};this.selectObject=function(a){e.selected.add(a);e.markers.update();1==e.selected.count()?e.selectedObject=e.selected.item(0):e.selectedObject=null};this.unselectAll=function(){this.selected.count()&&(this.selected.clear(),this.markers.update(),e.selectedObject=null)};this.print=function(){this.printMode=!0;d();this.printMode=!1};this.draw=function(){d();e.markers.draw()};this.update=function(){this.draw();
this.onObjectChange.call(this)}};var EditorFunctions=function(a){var b=function(a){"string"===typeof a&&(a=parseFloat(a.replace(",",".")));return a};this.toUnit=function(a){return b(a)/37.795};this.fromUnit=function(a){return 37.795*parseFloat(b(a))};this.windowToCanvas=function(c,b){var g=a.canvas.getBoundingClientRect();return{x:c-a.canvas.width/g.width*g.left,y:b-a.canvas.height/g.height*g.top}};this.clone=function(){if(a.selected.count()){var c=[];a.selected.each(function(){var a=this.clone();a.x+=20;a.y+=20;a.update();c.push(a)});
a.history.create(c);a.unselectAll();for(var b=0,g=c.length;b<g;b++)a.selectObject(c[b]);a.update()}};this.remove=function(){a.selected.count()&&(a.history.remove(a.selected.items()),a.selected.each(function(){a.objects.remove(this)}),a.unselectAll(),a.update())};this.align=function(){if(a.selected.count()){var c=a.selected.item(0),b=$(this).data("prop");a.history.change(a.selected.items(),["x","y"]);a.selected.each(function(){switch(b){case "left":this.x=c.x;break;case "center":this.x=c.x+c.width/
2-this.width/2;break;case "right":this.x=c.x+c.width-this.width;break;case "top":this.y=c.y;break;case "middle":this.y=c.y+c.height/2-this.height/2;break;case "bottom":this.y=c.y+c.height-this.height}});a.markers.update();a.update()}};this.insertImage=function(c){if(1==a.selected.count()){var b=a.selected.item(0);b.image=new Image;b.image.onload=b.image.onerror=function(){b.text="";b.update();a.update();a.history.change([a.selectedObject],["text"])};b.image.src=c.url}}};function EditorGroup(){var a=[];this.add=function(b){a.push(b)};this.remove=function(b){for(var c=0,d=a.length;c<d;c++)if(b==a[c])return a.splice(c,1),c;return null};this.item=function(b){return a[b]};this.items=function(){return a};this.clear=function(){a=[]};this.count=function(){return a.length};this.each=function(b){for(var c=0,d=a.length;c<d&&!1!==b.call(a[c]);c++);};this.reverseEach=function(b){for(var c=a.length-1;0<=c&&!1!==b.call(a[c]);c--);}};function EditorHistory(a){var b=[],c=0,d=this;this.enableRedo=this.enableUndo=!1;this.onChange=null;var g=function(a,f,g){b[c]={operation:a,objects:f};if(g){a=[];for(var k=g.length,h=0,n=f.length;h<n;h++)for(var m=0;m<k;m++)f[h].hasOwnProperty(g[m])&&(a[g[m]]=f[h][g[m]]);b[c].props=a}100==b.length?(100).splice(0,1):c++;d.enableUndo=!0;d.onChange&&d.onChange.call(d)};this.change=function(a,b){g(0,a,b)};this.create=function(a){g(1,a)};this.remove=function(a){g(2,a)};var f=function(){var e,d,f=b[c].objects,
g=f.length,k=b[c].props;for(e=0;e<g;e++){for(var h in k)d=f[e][h],f[e][h]=k[h],k[h]=d;f[e].update();a.selectObject(f[e])}},k=function(){var e,d=b[c].objects,f=d.length;for(e=0;e<f;e++)a.objects.add(d[e]),a.selectObject(d[e])},h=function(){var e,d=b[c].objects,f=d.length;for(e=0;e<f;e++)a.objects.remove(d[e])};this.undo=function(){if(0<c){c--;a.unselectAll();switch(b[c].operation){case 0:f();break;case 1:h();break;case 2:k()}a.markers.update();a.update();d.enableUndo=0<c;d.enableRedo=!0;d.onChange&&
d.onChange.call(d)}};this.redo=function(){if(c<b.length){a.unselectAll();switch(b[c].operation){case 0:f();break;case 1:k();break;case 2:h()}a.markers.update();a.update();c++;d.enableUndo=!0;d.enableRedo=c<b.length;d.onChange&&d.onChange.call(d)}}};var editor,keyModeCtrl,keyModeShift,isChange=!1;function showNoty(a){return noty({text:a.text,theme:"defaultTheme",layout:a.layout?a.layout:"bottomLeft",type:a.type?a.type:"information",dismissQueue:!1,timeout:a.timeout?a.timeout:1400,modal:a.modal?a.modal:!1,closeWith:a.modal?[]:["click"],force:!0,killer:!0})}showNoty({text:"\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430...",theme:"defaultTheme",layout:"topCenter",type:"success",timeout:!1});
jQuery.fn.disableSelection=function(){this.each(function(){this.onselectstart=function(){return!1};this.unselectable="on";jQuery(this).css({"-moz-user-select":"none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"});jQuery(this).bind("mousedown",function(){return!1})})};jQuery.fn.disabled=function(a){$(this).each(function(){a?$(this).attr("disabled","disabled"):$(this).removeAttr("disabled")});return $(this)};
function changeObjectColor(){if(editor.selectedObject){var a=$(this),b=a.data("te-prop");"undefined"===typeof b&&(b=a.parent().next("input").data("te-prop"));editor.selectedObject[b]=a.val();editor.update()}}
$(function(){function a(a){if(editor.selectedObject){var b;$(this).hasClass("active")?(b=!1,$(this).removeClass("active")):(b=!0,$(this).addClass("active"));editor.history.change([editor.selectedObject],[a.data.param]);editor.selectedObject[a.data.param]=b;editor.selectedObject.updateFont();editor.update()}}var b=$("#te-btn-save"),c=$("#te-btn-print"),d=$("#save-config"),g=$("#te-btn-copy"),f=$("#te-btn-create"),k=$("#te-btn-undo"),h=$("#te-btn-redo"),e=$("#te-btn-delete"),l=$("#te-text"),q=$("#te-templates"),
u=$("#te-font"),r=$("#te-btn-bold"),n=$("#te-btn-italic"),m=$(".align"),A=$(".m-align"),x=$("[data-te-size-prop]"),y=$("[data-te-prop]"),p=$(".valign");editor=new Editor;editor.setCanvas(document.getElementById("paper"));editor.onObjectChange=function(a){editor.selectedObject?($(".only-select").disabled(!1),x.each(function(){var a=editor.selectedObject[$(this).data("te-size-prop")];$(this).val(editor.fn.toUnit(a).toFixed(2))}),a||(y.each(function(){var a=$(this).data("te-prop"),b=editor.selectedObject[a];
null==b&&"fillStyle"==a||$(this).val(b)}),l.val(editor.selectedObject.getText()),m.removeClass("active"),$('.align[data-te-prop="'+editor.selectedObject.textAlign+'"]').addClass("active"),p.each(function(){$(this).parent().removeClass("active")}),$('.valign[data-te-prop="'+editor.selectedObject.textBaseline+'"]').parent().addClass("active"),editor.selectedObject.fontBold?r.addClass("active"):r.removeClass("active"),editor.selectedObject.fontItalic?n.addClass("active"):n.removeClass("active"))):($(".only-select, .only-select2").disabled(!0),
1<editor.selected.count()&&$(".only-select2").disabled(!1))};editor.history.onChange=function(){isChange=!0;b.disabled(!1);k.disabled(!this.enableUndo);h.disabled(!this.enableRedo)};f.click(function(){var a=new EditorObject(editor);a.text="";a.width=a.height=150;a.x=editor.canvas.width/2-a.width/2;a.y=editor.canvas.height/2-a.height/2;a.update();editor.history.create([a]);editor.unselectAll();editor.selectObject(a);editor.update()});c.click(function(){(new EditorPrinter([editor],!0)).print();keyModeShift=
keyModeCtrl=null});$("#te-btn-close").click(function(){if(!isChange||confirm("\u0412\u044b \u0441\u043e\u0431\u0438\u0440\u0430\u0435\u0442\u0435\u0441\u044c \u0443\u0439\u0442\u0438 \u0441\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b. \u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u0431\u0443\u0434\u0443\u0442 \u043f\u043e\u0442\u0435\u0440\u044f\u043d\u044b. \u0423\u0439\u0442\u0438?"))location.href=$(this).data("url")});d.click(function(){var a=$("#form-config");$("#modal-config").modal("hide");
$.post(a.attr("action"),a.serialize(),function(a){a.result?(editor.canvas.width=editor.fn.fromUnit($("#template-width").val()),editor.canvas.height=editor.fn.fromUnit($("#template-height").val()),editor.update()):$("#modal-config").modal("show");showNoty({text:a.message,type:a.result?"success":"error"})})});b.click(function(){var a=new Serialize,a={id:templateData.id,objects:a.save(editor.objects)},c=showNoty({text:"\u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435...",theme:"defaultTheme",
timeout:!1});$.post(templateData.saveUrl,a,function(a){c.setText(a.message);c.setType(a.result?"success":"error");b.disabled(!0);isChange=!1})});k.click(editor.history.undo);h.click(editor.history.redo);e.click(editor.fn.remove);g.click(editor.fn.clone);y.change(function(){if(editor.selectedObject){var a=$(this).attr("data-te-prop"),b=$(this).val();$(this).attr("data-unit")&&(b=editor.fn.fromUnit(b));editor.history.change([editor.selectedObject],[a]);editor.selectedObject[a]=b;editor.selectedObject.update();
editor.markers.update(editor.selected);editor.draw()}});x.change(function(){if(editor.selectedObject){var a=$(this).attr("data-te-size-prop");editor.history.change([editor.selectedObject],[a]);editor.selectedObject[a]=editor.fn.fromUnit($(this).val());editor.selectedObject.update();editor.markers.update(editor.selected);editor.draw()}});var v=!1,w=!1;l.bind("keyup change",function(){editor.selectedObject&&(v&&!w&&(editor.history.change([editor.selectedObject],["text"]),w=!0),editor.selectedObject.setText($(this).val()),
editor.draw())}).focus(function(){v=!0;w=!1}).blur(function(){v=!1});q.dblclick(function(){editor.selectedObject&&(l.val(l.val()+$(this).val()),l.change())});var z=!1;$("#add-img").click(function(){if(editor.selectedObject){var a=$("#modal-elfinder");a.modal();z||$.get(a.data("url"),function(b){a.find(".modal-body").html(b);z=!0})}return!1});p.click(function(){editor.selectedObject&&(editor.selectedObject.textBaseline=$(this).data("te-prop"),editor.selectedObject.updateTextLines(),editor.update(),
p.each(function(){$(this).parent().removeClass("active")}),$(this).parent().addClass("active"))});u.change(function(){editor.selectedObject&&(editor.history.change([editor.selectedObject],["fontFamily"]),editor.selectedObject.fontFamily=$(this).val(),editor.selectedObject.updateTextLines(),editor.update())});r.click({param:"fontBold"},a);n.click({param:"fontItalic"},a);m.click(function(){editor.selectedObject&&(editor.history.change([editor.selectedObject],["textAlign"]),editor.selectedObject.textAlign=
$(this).data("te-prop"),editor.update(),m.removeClass("active"),$(this).addClass("active"));return!1});p.click(function(){editor.selectedObject&&(editor.history.change([editor.selectedObject],["textBaseline"]),editor.selectedObject.textBaseline=$(this).data("te-prop"),editor.update(),p.each(function(){$(this).parent().removeClass("active")}),$(this).parent().addClass("active"));return!1});A.click(editor.fn.align);var t=$(".middle");t.length&&(d=function(){var a=$(window).height()-t.offset().top;t.height(a)},
$(window).resize(d),d());t.disableSelection();$(".only-select").disabled(!0);b.disabled(!0);$(document).keydown(function(a){keyModeCtrl=a.ctrlKey;keyModeShift=a.shiftKey;if(a.ctrlKey)switch(String.fromCharCode(a.which).toLowerCase()){case "s":a.preventDefault();b.click();break;case "p":a.preventDefault();c.click();break;case "d":a.preventDefault();g.click();break;case "z":a.shiftKey?h.click():k.click();a.preventDefault();break;case "b":r.click();break;case "i":n.click()}}).keyup(function(a){keyModeCtrl=
a.ctrlKey;keyModeShift=a.shiftKey;switch(a.which){case 46:(!this.activeElement||"TEXTAREA"!=this.activeElement.nodeName&&"INPUT"!=this.activeElement.nodeName)&&e.click()}});$.get(templateData.loadUrl,function(a){var b=new Serialize(editor);b.callback=function(a){a&&($.noty.closeAll(),editor.update())};b.load(a)})});function Markers(a){this.height=this.width=this.y=this.x=0;var b=!1,c=[],d=this;this.cursors="nw-resize n-resize sw-resize w-resize w-resize sw-resize n-resize nw-resize".split(" ");this.update=function(){if(0==a.selected.count())b=!1;else{b=!0;var g=0,f=0;d.x=Infinity;d.y=Infinity;a.selected.each(function(){d.x>this.x&&(d.x=this.x);d.y>this.y&&(d.y=this.y);g<this.x+this.width&&(g=this.x+this.width);f<this.y+this.height&&(f=this.y+this.height)});this.width=g-this.x;this.height=f-this.y;c[0]={x:this.x-
6,y:this.y-6};c[1]={x:this.x+this.width/2-3,y:this.y-6};c[2]={x:this.x+this.width,y:this.y-6};c[3]={x:this.x-6,y:this.y+this.height/2-3};c[4]={x:this.x+this.width,y:this.y+this.height/2-3};c[5]={x:this.x-6,y:this.y+this.height};c[6]={x:this.x+this.width/2-3,y:this.y+this.height};c[7]={x:this.x+this.width,y:this.y+this.height}}};this.testPoint=function(a){if(b)for(var d=0;8>d;d++)if(a.x>c[d].x&&a.y>c[d].y&&a.x<c[d].x+6&&a.y<c[d].y+6)return d;return null};this.draw=function(){if(b){a.context.fillStyle=
"#337AB7";for(var d=0;8>d;d++)a.context.fillRect(c[d].x,c[d].y,6,6)}}};function EditorObject(a){this.lineWidth=this.height=this.width=this.y=this.x=0;this.strokeStyle="#000000";this.fillStyle=null;this.textStyle="#000000";this.textAlign="center";this.textBaseline="middle";this.lineHeight=25;this.fontFamily="Arial";this.fontSize=16;this.fontItalic=this.fontBold=!1;this.image=this.text=null;this.old={};this.font="";this.lines=[];this.textHeight=0;a.objects.add(this);this.clone=function(){var b=new EditorObject(a),c;for(c in this)b.hasOwnProperty(c)&&(b[c]=this[c]);return b};
this.testPoint=function(a){return a.x>this.x&&a.y>this.y&&a.x<this.x+this.width&&a.y<this.y+this.height};this.updateOld=function(){this.old.x=this.x;this.old.y=this.y;this.old.width=this.width;this.old.height=this.height;this.old.rx=a.markers.x/this.x;this.old.rw=this.width/a.markers.width;this.old.ry=a.markers.y/this.y;this.old.rh=this.height/a.markers.height};this.setText=function(a){this.text=a;this.updateTextLines()};this.getText=function(){return this.text};this.update=function(){this.updateFont();
this.updateTextLines()};this.updateFont=function(){this.font="";this.fontItalic&&(this.font+="italic ");this.fontBold&&(this.font+="bold ");this.lineHeight=1.4*this.fontSize;this.font+=this.fontSize+"pt "+this.fontFamily};this.updateTextLines=function(){this.lines=[];if(this.text&&""!=this.text){var b=this.text.split("\n"),c=b.length,d=a.context;this.textHeight=this.lineHeight*c;a.context.font=this.font;for(var g=0;g<c;g++){for(var f="",k=b[g].split(" "),h=0,e=k.length;h<e;h++){var l=f+k[h];d.measureText(l).width>
this.width-10?(this.lines.push(f),this.textHeight+=this.lineHeight,f=k[h]+" "):f=l+" "}this.lines.push(f)}this.textHeight-=this.lineHeight}};this.draw=function(){var b=a.context;this.fillStyle&&(b.fillStyle=this.fillStyle,b.fillRect(this.x,this.y,this.width,this.height));this.image&&b.drawImage(this.image,20,20,this.image.naturalWidth-40,this.image.naturalHeight-40,this.x,this.y,this.width,this.image.naturalHeight*this.width/this.image.naturalWidth);0<this.lineWidth?(b.strokeStyle=this.strokeStyle,
b.lineWidth=this.lineWidth,b.setLineDash([]),b.strokeRect(this.x,this.y,this.width,this.height)):this.fillStyle||!a.showFrame||a.printMode||(b.setLineDash([1,2]),b.strokeStyle="#888888",b.lineWidth=1,b.strokeRect(this.x,this.y,this.width,this.height));var c;if(c=this.lines.length){b.fillStyle=this.textStyle;b.font=this.font;b.textAlign=this.textAlign;b.textBaseline=this.textBaseline;var d,g;g="left"==this.textAlign?this.x:"right"==this.textAlign?this.x+this.width:this.x+this.width/2;d="top"==this.textBaseline?
this.y:"bottom"==this.textBaseline?this.y+this.height-this.textHeight:this.y+this.height/2-this.textHeight/2;for(var f=0;f<c&&!(d>=this.y&&b.fillText(this.lines[f],g,d),d+=this.lineHeight,d>this.y+this.height);f++);}}};function EditorPrinter(a,b){var c=b?window.open():window;this.print=function(){c.document.write("<head><title>NovatorPriceService</title><style>@page :first {margin: 0.5cm} @page :left { margin: 0.5cm } @page :right { margin: 0.5cm } @media print and (color) { * { -webkit-print-color-adjust: exact; print-color-adjust: exact }} body {margin:0; width:100%} img {margin:0; outline:none} table {margin: 0} table td {padding: 0}</style></head><body>");var d=0,g=parseInt(a[0].fn.fromUnit(21)/a[0].canvas.width),
f='style="width:'+a[0].canvas.width+"px;height:"+a[0].canvas.height+'px"';c.document.write("<table><tr>");for(var k=0;k<a.length;k++){c.document.write("<td "+f+">");var h=a[k];c.document.write('<canvas id="p1"></canvas>');var e=document.getElementById("p1");e.width=793;e.height=1111;h.setCanvas(e);h.print();c.document.write("</td>");d++;d>=g&&(d=0,c.document.write("</td></tr><tr>"))}c.document.write("</tr></table>");c.document.write("</body>");b&&a[0].update()}};function Serialize(a){function b(){g--;0==g&&f.callback(!0)}function c(a){a.each(function(){var a;(a=/\[image:(.*)\]/.exec(this.text))?(g++,this.image=new Image,-1!=a[1].indexOf("http")&&(this.image.crossOrigin=""),this.image.onload=this.image.onerror=b,this.image.src=a[1],this.text=null):this.update()})}var d="x y width height text lineWidth strokeStyle fillStyle textStyle textAlign textBaseline lineHeight fontFamily fontSize fontBold fontItalic".split(" ");this.save=function(a){var b=[],c,f=d.length;
a.each(function(){var a={};for(c=0;c<f;c++)a[d[c]]=this[d[c]];null!=this.image&&(a.text="[image:"+this.image.src+"]");b.push(a)});return JSON.stringify({version:"1.0.0",objects:b})};this.callback=null;this.editor=a;var g=0,f=this;this.load=function(a){if(""==a)return!1;if((a=JSON.parse(a))&&a.hasOwnProperty("version")&&a.hasOwnProperty("objects")&&"1.0.0"==a.version){a=a.objects;var b=d.length,e,l,q;e=0;for(q=a.length;e<q;e++){var u=new EditorObject(f.editor);for(l=0;l<b;l++)u[d[l]]=a[e][d[l]]}c(f.editor.objects)}else f.callback(!1);
0==g&&f.callback(!0)}};
